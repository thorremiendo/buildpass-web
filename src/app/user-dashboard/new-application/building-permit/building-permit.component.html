<ng-container *ngIf="applicationDetails">
  <h3>Building Permit Application</h3>
  <p>
    Click <a href="" target="_blank">here</a> to view all required forms for
    Building Permit Application.
  </p>
  <h4 style="font-weight: bold; color: grey">
    Uploaded Documents: {{ getUniqueUserDocs() }}/
    {{ getFieldSetsLength() + getFormsLength() }}
  </h4>
  <mat-horizontal-stepper
    linear="false"
    #stepper
    (selectionChange)="initPdfViewer($event)"
  >
    <mat-step *ngFor="let form of forms; let i = index">
      <ng-template matStepLabel>{{ form.label }}</ng-template>

      <div class="row">
        <h1>{{ form.description }}</h1>
        <mat-icon class="info" [tooltip]="tolTemplate" placement="bottom"
          >info</mat-icon
        >
      </div>
      <ng-template #tolTemplate>
        <img [src]="sampleForm" />
      </ng-template>
      <div class="fillable-form">
        <div class="d-flex justify-content-between align-items-center">
          <div class="step-label">
            After filling out the form, please click the next button to proceed
          </div>
          <mat-slide-toggle
            [(ngModel)]="isOptional"
            *ngIf="!form.path"
            (change)="onToggleChange($event, form)"
            ><span style="font-size: 14px; font-weight: bold"
              >Not Applicable</span
            ></mat-slide-toggle
          >
        </div>

        <div id="form-{{ i }}">
          <div id="pdf-viewer" *ngIf="i == 0 && pdfSource">
            <ngx-extended-pdf-viewer
              [src]="pdfSource"
              [showToolbar]="true"
              [showSidebarButton]="false"
              [showFindButton]="false"
              [showPagingButtons]="false"
              [showZoomButtons]="true"
              [showPresentationModeButton]="true"
              [showOpenFileButton]="false"
              [showPrintButton]="false"
              [showDownloadButton]="true"
              [showBookmarkButton]="false"
              [showSecondaryToolbarButton]="true"
              [showRotateButton]="false"
              [showHandToolButton]="false"
              [showScrollingButton]="false"
              [showSpreadButton]="false"
              [showPropertiesButton]="false"
              [useBrowserLocale]="true"
              height="1000px"
              zoom="100%"
              [(formData)]="formData"
            >
            </ngx-extended-pdf-viewer>
          </div>
        </div>

        <ng-container>
          <!-- <app-file-upload
            (emitFile)="submitDocument($event, form.id)"
            description="{{ form.description }}"
            path="{{ form.path }}"
          ></app-file-upload> -->
          <div class="row mt-4">
            <div class="file-description col-8">
              <p style="font-weight: bold; color: maroon">
                {{ form.description }}
              </p>
            </div>
            <div class="file-actions col-4">
              <div *ngIf="!isLoading">
                <a *ngIf="form.path" [href]="form.path" target="_blank"
                  >View File</a
                >
                <span
                  *ngIf="
                    form.path &&
                    form.id !== 1 &&
                    form.id !== 2 &&
                    form.id !== 3 &&
                    form.id !== 4 &&
                    form.id !== 48 &&
                    form.id !== 106
                  "
                  (click)="toggleEditMode()"
                  >Change</span
                >
                <mat-icon *ngIf="file || form.path"> check_circle </mat-icon>
              </div>
              <mat-spinner *ngIf="isLoading" [diameter]="20"> </mat-spinner>
            </div>
          </div>
        </ng-container>
      </div>
      <div class="buttons">
        <button
          mat-raised-button
          color="accent"
          (click)="upload(form, 'draft')"
          [disabled]="isLoading"
        >
          Save as Draft
        </button>
        <!-- <button
          mat-raised-button
          color="primary"
          (click)="handleSaveFormData(form.id)"
          matStepperNext
          [disabled]="isLoading"
        >
          Save
        </button> -->
        <button
          mat-raised-button
          color="primary"
          matStepperNext
          (click)="upload(form, 'next')"
          [disabled]="isLoading"
        >
          Next
        </button>
        <!-- <button
          *ngIf="form.path"
          mat-raised-button
          matStepperNext
          color="primary"
          [disabled]="isLoading"
        >
          Next
        </button> -->
      </div>
    </mat-step>
    <mat-step *ngFor="let fieldSet of fieldSets; let i = index">
      <ng-template matStepLabel>{{ fieldSet.label }}</ng-template>
      <div class="fieldsets">
        <h1>{{ fieldSet.title }}</h1>
        <div *ngFor="let field of fieldSet.documents">
          <app-file-upload
            (emitFile)="submitDocument($event, field.id)"
            description="{{ field.description }}"
            path="{{ field.path }}"
            info="{{ field.info }}"
            formId="{{ field.id }}"
            [applicationDetails]="applicationDetails"
          ></app-file-upload>
        </div>
      </div>
      <div class="buttons">
        <button
          mat-raised-button
          color="accent"
          [routerLink]="['/dashboard/applications']"
          [disabled]="isLoading"
        >
          Save as Draft
        </button>
        <button
          mat-raised-button
          color="primary"
          matStepperNext
          *ngIf="i != fieldSets.length - 1; else submit_button"
          [disabled]="isLoading"
        >
          Next
        </button>
        <ng-template #submit_button>
          <button
            mat-raised-button
            (click)="submitApplication()"
            [disabled]="isLoading"
          >
            Continue
          </button>
        </ng-template>
      </div>
    </mat-step>
  </mat-horizontal-stepper>
</ng-container>
<ng-container *ngIf="isLoading">
  <div>
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  </div>
</ng-container>
<ng-container *ngIf="!applicationDetails">
  <div class="spinner">
    <mat-spinner></mat-spinner>
  </div>
</ng-container>
