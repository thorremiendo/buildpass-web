<ng-container *ngIf="applicationInfo && evaluatorRole">
  <mat-card *ngIf="!isLoading">
    <mat-card-content>
      <div class="d-flex justify-content-between align-items-center">
        <h4 style="color: #400c06" class="mb-4">
          <strong>Application Forms</strong>
        </h4>
        <div class="reject" *ngIf="evaluatorRole.code == 'CBAO-BO'">
          <button
            mat-raised-button
            color="accent"
            (click)="handleReject()"
            [disabled]="checkFormsCompliant()"
          >
            <mat-icon>cancel</mat-icon>
            Reject Application
          </button>
        </div>
      </div>
      <ng-container
        *ngIf="
          applicationInfo.permit_type_id == 1 ||
          applicationInfo.permit_type_id == 2
        "
      >
        <div
          *ngIf="
            applicationInfo.application_status_id == 3 ||
            applicationInfo.application_status_id == 12 ||
            applicationInfo.application_status_id == 5
          "
        >
          <div class="row ml-1">
            <h5>
              <strong> BFP Status: </strong>
            </h5>
            <h5
              [style.color]="
                applicationInfo.parallel_bfp_status_id !== 1 ? 'red' : 'green'
              "
            >
              &nbsp;
              {{
                applicationInfo.parallel_bfp_status_id == 0
                  ? "Pending"
                  : applicationInfo.parallel_bfp_status_id == 1
                  ? "Review Done - Compliant"
                  : "Review Done - Non Compliant"
              }}
            </h5>
          </div>
          <div class="row ml-1">
            <h5>
              <strong> CEPMO Status: </strong>
            </h5>
            <h5
              [style.color]="
                applicationInfo.parallel_cepmo_status_id !== 1 ? 'red' : 'green'
              "
            >
              &nbsp;
              {{
                applicationInfo.parallel_cepmo_status_id == 0
                  ? "Pending"
                  : applicationInfo.parallel_cepmo_status_id == 1
                  ? "Review Done - Compliant"
                  : "Review Done - Non Compliant"
              }}
            </h5>
          </div>
          <div class="row ml-1">
            <h5>
              <strong> CBAO Status: </strong>
            </h5>
            <h5
              [style.color]="
                applicationInfo.parallel_cbao_status_id !== 1 ? 'red' : 'green'
              "
            >
              &nbsp;
              {{
                applicationInfo.parallel_cbao_status_id == 0
                  ? "Pending"
                  : applicationInfo.parallel_cbao_status_id == 1
                  ? "Review Done - Compliant"
                  : "Review Done - Non Compliant"
              }}
            </h5>
          </div>
        </div>
      </ng-container>

      <mat-tab-group>
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>assignment</mat-icon>
            Documents
          </ng-template>
          <div class="mt-3" *ngIf="evaluatorRole.code == 'SPRADM'">
            <button
              mat-raised-button
              color="accent"
              (click)="openOccupancyFileUpload()"
            >
              Upload File
            </button>
          </div>

          <div>
            <div class="document-search col-12 col-md-6">
              <mat-form-field appearance="outline">
                <mat-label>Search</mat-label>
                <input matInput [formControl]="searchKey" />
                <mat-icon matSuffix>search</mat-icon>
              </mat-form-field>
            </div>

            <div class="table-container" *ngIf="dataSource">
              <table mat-table [dataSource]="dataSource">
                <!-- Index Column -->
                <ng-container matColumnDef="index">
                  <th mat-header-cell *matHeaderCellDef></th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <mat-icon *ngIf="element[documentStatusSelector] == 0"
                      >assignment</mat-icon
                    >
                    <mat-icon *ngIf="element[documentStatusSelector] == 1"
                      >assignment_turned_in</mat-icon
                    >
                    <mat-icon *ngIf="element[documentStatusSelector] == 2"
                      >assignment_late</mat-icon
                    >
                  </td>
                </ng-container>

                <!--  Name Column -->
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>Uploaded Documents</th>
                  <td
                    mat-cell
                    *matCellDef="let element"
                    [ngClass]="{ 'doc-category-header': element.label }"
                  >
                    {{ !element.label ? element.docName : element.label }}
                    <!-- {{ element.document_id }} -->
                  </td>
                </ng-container>

                <!-- Uploaded By Column -->
                <ng-container matColumnDef="uploadedBy">
                  <th mat-header-cell *matHeaderCellDef>Uploaded By</th>
                  <td mat-cell *matCellDef="let element">
                    <div *ngIf="!element.label">
                      {{
                        element.is_uploaded_by_non_applicant == 1
                          ? "Admin"
                          : "Applicant"
                      }}
                    </div>
                  </td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef>Status</th>
                  <td mat-cell *matCellDef="let element">
                    <div *ngIf="!element.label">
                      {{
                        evaluatorRole.code == "CBAO-REC"
                          ? getDocStatus(
                              element.receiving_status_id,
                              element.is_applicable
                            )
                          : evaluatorRole.code == "CBAO-DC" ||
                            evaluatorRole.code == "CBAO-BO" ||
                            evaluatorRole.code == "CBAO-REL" ||
                            (applicationInfo.permit_type_id !== 1 &&
                              applicationInfo.permit_type_id !== 2)
                          ? getDocStatus(
                              element.document_status_id,
                              element.is_applicable
                            )
                          : getDocStatus(
                              element.cbao_status_id,
                              element.is_applicable
                            )
                      }}
                    </div>
                  </td>
                </ng-container>

                <!-- Remarks Column -->
                <ng-container matColumnDef="remarks">
                  <th mat-header-cell *matHeaderCellDef>Remarks</th>
                  <td mat-cell *matCellDef="let element">
                    <mat-icon
                      *ngIf="!element.label"
                      class="remark"
                      (click)="openRemarksHistory(element)"
                      [matBadge]="element.document_revision.length"
                      matBadgeColor="warn"
                      >remove_red_eye</mat-icon
                    >
                  </td>
                </ng-container>

                <!-- Action Column -->
                <ng-container matColumnDef="action">
                  <th mat-header-cell *matHeaderCellDef>Action</th>
                  <td mat-cell *matCellDef="let element">
                    <ng-container
                      *ngIf="
                        element.label ==
                          'Plans, Designs, Specifications, Cost Estimate' &&
                        evaluatorRole.code == 'CBAO-BO'
                      "
                    >
                      <a
                        mat-menu-item
                        (click)="openMergedPlans()"
                        *ngIf="mergedPlans && !isLoadingMergedPlans"
                        >View Plans</a
                      >
                      <p *ngIf="isLoadingMergedPlans">loading plans..</p>
                    </ng-container>
                    <div *ngIf="!element.label">
                      <button mat-button [matMenuTriggerFor]="menu">
                        Select <mat-icon> arrow_drop_down </mat-icon>
                      </button>
                      <mat-menu #menu="matMenu">
                        <!-- <ng-container *ngIf="evaluatorRole.code == 'SPRADM'">
                          <button
                            mat-menu-item
                            color="accent"
                            (click)="openFormDialog(element)"
                            [disabled]="
                              element.document_id == 194 ||
                              element.document_id == 44
                            "
                          >
                            Evaluate
                          </button>
                        </ng-container> -->

                        <ng-container
                          *ngIf="
                            applicationInfo.permit_type_id == 1 ||
                            applicationInfo.permit_type_id == 2
                          "
                        >
                          <button
                            mat-menu-item
                            color="accent"
                            (click)="openFormDialog(element)"
                            [disabled]="
                              applicationInfo.application_status_id !== 1
                            "
                            *ngIf="evaluatorRole.code == 'CBAO-REC'"
                          >
                            Evaluate
                          </button>
                          <button
                            mat-menu-item
                            color="accent"
                            (click)="openBldgPermitDialog(element)"
                            *ngIf="
                              evaluatorRole.code == 'CBAO-REL' &&
                              element.document_id == 50
                            "
                            [disabled]="
                              element.document_id == 194 ||
                              element.document_id == 44
                            "
                          >
                            Evaluate
                          </button>
                          <button
                            mat-menu-item
                            color="accent"
                            (click)="openFormDialog(element)"
                            [disabled]="
                              applicationInfo.application_status_id !== 3 ||
                              element.document_id == 194 ||
                              element.document_id == 44 ||
                              element.document_id == 224
                            "
                            *ngIf="
                              evaluatorRole.code == 'CBAO-LG' ||
                              evaluatorRole.code == 'CBAO-ARCH' ||
                              evaluatorRole.code == 'CBAO-STR' ||
                              evaluatorRole.code == 'CBAO-SAN' ||
                              evaluatorRole.code == 'CBAO-ELEC' ||
                              evaluatorRole.code == 'CBAO-MEC'
                            "
                          >
                            Evaluate
                          </button>
                          <button
                            mat-menu-item
                            color="accent"
                            (click)="openFormDialog(element)"
                            [disabled]="
                              applicationInfo.application_status_id !== 12 ||
                              element.document_id == 194 ||
                              element.document_id == 44 ||
                              element.document_id == 224
                            "
                            *ngIf="evaluatorRole.code == 'CBAO-DC'"
                          >
                            Evaluate
                          </button>
                          <button
                            mat-menu-item
                            color="accent"
                            (click)="openFormDialog(element)"
                            [disabled]="
                              applicationInfo.application_status_id !== 13 ||
                              element.document_id == 194 ||
                              element.document_id == 44 ||
                              element.document_id == 224
                            "
                            *ngIf="evaluatorRole.code == 'CBAO-BO'"
                          >
                            Evaluate
                          </button>
                        </ng-container>
                        <ng-container
                          *ngIf="
                            applicationInfo.permit_type_id !== 1 &&
                            applicationInfo.permit_type_id !== 2
                          "
                        >
                          <button
                            mat-menu-item
                            color="accent"
                            (click)="openFormDialog(element)"
                            *ngIf="evaluatorRole.code !== 'CBAO-REL'"
                            [disabled]="!otherPermitsCanEdit()"
                          >
                            Evaluate
                          </button>
                        </ng-container>

                        <button
                          mat-menu-item
                          color="accent"
                          (click)="
                            openAdminEditDialog(
                              element.id,
                              element.document_status_id
                            )
                          "
                          *ngIf="evaluatorRole.code == 'SPRADM'"
                        >
                          Change Status
                        </button>
                        <button
                          mat-menu-item
                          color="accent"
                          (click)="openAdminWatermark(element)"
                          *ngIf="evaluatorRole.code == 'SPRADM'"
                        >
                          Insert Watermark
                        </button>
                        <button
                          mat-menu-item
                          color="accent"
                          (click)="deleteUserDocument(element)"
                          *ngIf="evaluatorRole.code == 'SPRADM'"
                        >
                          Delete File
                        </button>
                        <button
                          mat-menu-item
                          color="accent"
                          (click)="openUploadDocument(element)"
                          *ngIf="
                            (this.user.user_roles[0].is_special == 1 ||
                              evaluatorRole.code == 'CBAO-REC' ||
                              evaluatorRole.code == 'CBAO-REL' ||
                              evaluatorRole.code == 'SPRADM') &&
                            isDocumentAForm(element.document_id)
                          "
                          [disabled]="applicationInfo.permit_type_id == 2"
                        >
                          Update Fields
                        </button>
                        <button
                          mat-menu-item
                          color="accent"
                          (click)="openUpdateDocumentFile(element)"
                          *ngIf="
                            this.user.user_roles[0].is_special == 1 ||
                            evaluatorRole.code == 'CBAO-REC' ||
                            evaluatorRole.code == 'SPRADM' ||
                            evaluatorRole.code == 'CBAO-REL'
                          "
                        >
                          Update File
                        </button>

                        <ng-container>
                          <a
                            mat-menu-item
                            href="{{ element.document_path }}"
                            target="_blank"
                            >View</a
                          >
                        </ng-container>

                        <button
                          mat-menu-item
                          color="accent"
                          (click)="goToEsig(element.id)"
                          *ngIf="
                            evaluatorRole.code !== 'CBAO-REL' &&
                            evaluatorRole.code !== 'SPRADM'
                          "
                          [disabled]="evaluatorRole.code == 'CBAO-REC'"
                        >
                          Sign Document
                        </button>
                        <a
                          mat-menu-item
                          href="{{ element.document_path }}"
                          target="_blank"
                          *ngIf="
                            evaluatorRole.code == 'CBAO-REL' ||
                            evaluatorRole.code == 'SPRADM'
                          "
                          >Print</a
                        >
                      </mat-menu>
                    </div>
                  </td>
                </ng-container>

                <tr
                  mat-header-row
                  *matHeaderRowDef="displayedColumns; sticky: true"
                ></tr>
                <tr
                  mat-row
                  *matRowDef="let row; columns: displayedColumns"
                  [ngClass]="{
                    pending: row[documentStatusSelector] == 0,
                    'not-applicable':
                      row[documentStatusSelector] == 1 &&
                      row.is_applicable == 2,
                    compliant:
                      row[documentStatusSelector] == 1 &&
                      row.is_applicable !== 2,
                    'non-compliant': row[documentStatusSelector] == 2,
                    hidden: row.label && row.label == 'hidden'
                  }"
                ></tr>
              </table>
            </div>

            <div class="action__buttons">
              <ng-container *ngIf="applicationInfo.permit_type_id == 1">
                <!-- TODO MAKE THIS A COMPONENT -->

                <mat-progress-bar
                  mode="indeterminate"
                  *ngIf="isLoading"
                ></mat-progress-bar>
                <div *ngIf="evaluatorRole.code !== 'CBAO-BO'"></div>

                <div class="d-flex justify-content-between mt-5">
                  <div
                    *ngIf="
                      evaluatorRole.code !== 'CBAO-BO' &&
                      evaluatorRole.code !== 'CBAO-REC' &&
                      evaluatorRole.code !== 'CBAO-DC'
                    "
                    class="d-flex justify-content-between w-100"
                  >
                    <div></div>
                    <button
                      mat-raised-button
                      color="accent"
                      (click)="handleReviewDone()"
                      *ngIf="
                        evaluatorRole.code !== 'CBAO-BO' &&
                        evaluatorRole.code !== 'CBAO-REC' &&
                        evaluatorRole.code !== 'CBAO-DC' &&
                        applicationInfo.application_status_id == 3
                      "
                    >
                      Review Done
                    </button>
                  </div>
                  <div *ngIf="applicationInfo.application_status_id !== 11">
                    <div
                      *ngIf="
                        applicationInfo.application_status_id !== 5 &&
                        (evaluatorRole.code == 'CBAO-REC' ||
                          evaluatorRole.code == 'CBAO-DC' ||
                          evaluatorRole.code == 'CBAO-BO')
                      "
                    >
                      <button
                        mat-raised-button
                        color="warn"
                        (click)="nonCompliant()"
                        *ngIf="applicationInfo.application_status_id !== 3"
                        [disabled]="
                          evaluatorRole.code == 'CBAO-REC' &&
                          applicationInfo.application_status_id !== 1
                        "
                      >
                        Return to Applicant
                      </button>
                    </div>
                  </div>
                  <div>
                    <div *ngIf="applicationInfo.application_status_id == 13">
                      <button
                        class="mt-2 w-100"
                        mat-raised-button
                        color="primary"
                        (click)="callSave()"
                        *ngIf="evaluatorRole.code == 'CBAO-BO'"
                        [disabled]="
                          checkBuildingPermitUploaded() ||
                          checkFormNonCompliant()
                        "
                      >
                        Approve
                      </button>
                    </div>
                    <button
                      [disabled]="checkFormNonCompliant()"
                      mat-raised-button
                      color="primary"
                      (click)="forwardToCpdo()"
                      *ngIf="
                        applicationInfo.application_status_id == 1 &&
                        evaluatorRole.code == 'CBAO-REC'
                      "
                    >
                      Forward to CPDO
                    </button>
                    <button
                      mat-raised-button
                      color="primary"
                      (click)="notifyBuildingOfficial()"
                      *ngIf="evaluatorRole.code == 'CBAO-DC'"
                      [disabled]="
                        !checkFormsCompliant() ||
                        applicationInfo.application_status_id !== 12
                      "
                    >
                      Forward to Building Official
                    </button>
                    <button
                      mat-raised-button
                      color="primary"
                      (click)="handleRelease()"
                      *ngIf="
                        evaluatorRole.code == 'CBAO-REL' &&
                        applicationInfo.application_status_id == '4'
                      "
                    >
                      Release Permit
                    </button>
                    <!-- <div
                      *ngIf="
                        evaluatorRole.code !== 'CBAO-BO' &&
                        evaluatorRole.code !== 'CBAO-REC' &&
                        evaluatorRole.code !== 'CBAO-DC'
                      "
                    >
                      <button
                        mat-raised-button
                        color="primary"
                        (click)="handleTechnicalEvaluatorCompliant()"
                        *ngIf="applicationInfo.application_status_id == '3'"
                      >
                        Review Done (Compliant)
                      </button>
                    </div> -->
                    <!-- <button
                      mat-raised-button
                      color="primary"
                      (click)="forPayment()"
                      *ngIf="evaluatorRole.code == 'CBAO-BO'"
                      [disabled]="
                        !checkBuildingPermitUploaded() ||
                        applicationInfo.application_status_id !== 13
                      "
                    >
                      Forward to Payment of Fees
                    </button> -->
                    <!-- <button
                      mat-raised-button
                      color="primary"
                      (click)="forSignature()"
                      *ngIf="evaluatorRole.code == 'CBAO-BO'"
                      [disabled]="
                        !checkBuildingPermitUploaded() ||
                        applicationInfo.application_status_id !== 13
                      "
                    >
                      For Signature
                    </button> -->
                  </div>
                </div>
              </ng-container>
              <ng-container
                *ngIf="
                  applicationInfo.permit_type_id !== 1 &&
                  applicationInfo.permit_type_id !== 2
                "
              >
                <app-other-permits
                  [applicationInfo]="applicationInfo"
                  [evaluatorDetails]="evaluatorDetails"
                  [evaluatorRole]="evaluatorRole"
                  [userDocuments]="userDocuments"
                ></app-other-permits>
              </ng-container>
              <ng-container *ngIf="applicationInfo.permit_type_id == 2">
                <app-occupancy-permit-actions
                  [applicationInfo]="applicationInfo"
                  [evaluatorDetails]="evaluatorDetails"
                  [evaluatorRole]="evaluatorRole"
                  [occupancyDocs]="occupancyDocs"
                ></app-occupancy-permit-actions>
              </ng-container>
            </div>
          </div>
        </mat-tab>

        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>report</mat-icon>
            General Remarks
            <mat-icon
              [matBadge]="applicationInfo.remarks.length"
              matBadgeColor="warn"
            ></mat-icon>
          </ng-template>
          <app-general-remarks
            [evaluatorDetails]="evaluatorDetails"
          ></app-general-remarks>
        </mat-tab>
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>folder</mat-icon>
            Supporting Documents
          </ng-template>
          <app-supporting-documents
            [evaluatorDetails]="evaluatorDetails"
            [applicationDetails]="applicationInfo"
          ></app-supporting-documents>
        </mat-tab>
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>engineering</mat-icon>
            Technical Evaluation
          </ng-template>
          <app-technical-evaluation
            [evaluatorDetails]="evaluatorDetails"
            [applicationDetails]="applicationInfo"
          ></app-technical-evaluation>
        </mat-tab>
        <mat-tab *ngIf="applicationInfo.permit_type_id == 1">
          <ng-template mat-tab-label>
            <mat-icon>find_in_page</mat-icon>
            Technical Findings
          </ng-template>
          <ng-container *ngIf="evaluatorDetails && applicationInfo">
            <app-technical-findings
              [evaluatorDetails]="evaluatorDetails"
              [applicationDetails]="applicationInfo"
            ></app-technical-findings>
          </ng-container>
        </mat-tab>
      </mat-tab-group>
    </mat-card-content>
  </mat-card>
</ng-container>

<div class="spinner mb-5" *ngIf="isLoading">
  <p style="color: maroon; text-align: center">Please wait..</p>
  <mat-spinner></mat-spinner>
</div>
