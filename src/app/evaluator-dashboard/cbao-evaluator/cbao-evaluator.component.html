<ng-container *ngIf="applicationInfo && evaluatorRole">
  <mat-card *ngIf="!isLoading">
    <mat-card-content>
      <div class="d-flex justify-content-between align-items-center">
        <h4 style="color: #400c06" class="mb-4">
          <strong>Application Forms</strong>
        </h4>
        <div class="reject" *ngIf="evaluatorRole.code == 'CBAO-BO'">
          <button
            mat-raised-button
            color="accent"
            (click)="handleReject()"
            [disabled]="checkFormsCompliant()"
          >
            <mat-icon>cancel</mat-icon>
            Reject Application
          </button>
        </div>
      </div>
      <ng-container *ngIf="applicationInfo.permit_type_id == 1">
        <div
          *ngIf="
            applicationInfo.application_status_id == 3 ||
            applicationInfo.application_status_id == 12
          "
        >
          <h5>
            <strong> BFP Status: </strong>
            {{
              applicationInfo.parallel_bfp_status_id == 0
                ? "Pending"
                : applicationInfo.parallel_bfp_status_id == 1
                ? "Review Done - Compliant"
                : "Review Done - Non Compliant"
            }}
          </h5>
          <h5>
            <strong> CEPMO Status: </strong>
            {{
              applicationInfo.parallel_cepmo_status_id == 0
                ? "Pending"
                : applicationInfo.parallel_cepmo_status_id == 1
                ? "Review Done - Compliant"
                : "Review Done - Non Compliant"
            }}
          </h5>
          <h5>
            <strong> CBAO Status: </strong>
            {{
              applicationInfo.parallel_cbao_status_id == 0
                ? "Pending"
                : applicationInfo.parallel_cbao_status_id == 1
                ? "Review Done - Compliant"
                : "Review Done - Non Compliant"
            }}
          </h5>
        </div>
      </ng-container>

      <mat-tab-group>
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>assignment</mat-icon>
            Applicant Forms
          </ng-template>
          <div class="mt-3">
            <button
              mat-raised-button
              color="accent"
              (click)="openOccupancyFileUpload()"
            >
              <mat-icon>add</mat-icon>&nbsp;Upload File
            </button>
          </div>

          <div>
            <div class="table-container">
              <table mat-table [dataSource]="dataSource">
                <ng-container matColumnDef="index">
                  <th mat-header-cell *matHeaderCellDef>No.</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    {{ i + 1 }}
                  </td>
                </ng-container>
                <!--  Name Column -->
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>Uploaded Documents</th>
                  <td mat-cell *matCellDef="let element">
                    {{ getDocType(element.document_id) }}
                  </td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef>Status</th>
                  <td mat-cell *matCellDef="let element">
                    {{
                      evaluatorRole.code == "CBAO-REC"
                        ? getDocStatus(element.receiving_status_id)
                        : evaluatorRole.code == "CBAO-DC" ||
                          evaluatorRole.code == "CBAO-BO" ||
                          evaluatorRole.code == "CBAO-REL" ||
                          applicationInfo.permit_type_id !== 1
                        ? getDocStatus(element.document_status_id)
                        : getDocStatus(element.cbao_status_id)
                    }}
                  </td>
                </ng-container>
                <ng-container matColumnDef="remarks">
                  <th mat-header-cell *matHeaderCellDef>Remarks</th>
                  <td mat-cell *matCellDef="let element">
                    <mat-icon
                      class="remark"
                      (click)="openRemarksHistory(element)"
                      [matBadge]="element.document_revision.length"
                      matBadgeColor="warn"
                      >remove_red_eye</mat-icon
                    >
                  </td>
                </ng-container>

                <!-- Action Column -->
                <ng-container matColumnDef="action">
                  <th mat-header-cell *matHeaderCellDef>Action</th>
                  <td mat-cell *matCellDef="let element">
                    <button mat-button [matMenuTriggerFor]="menu">
                      Select <mat-icon> arrow_drop_down </mat-icon>
                    </button>
                    <mat-menu #menu="matMenu">
                      <ng-container *ngIf="applicationInfo.permit_type_id == 1">
                        <button
                          mat-menu-item
                          color="accent"
                          (click)="openFormDialog(element)"
                          [disabled]="
                            applicationInfo.application_status_id !== 1
                          "
                          *ngIf="evaluatorRole.code == 'CBAO-REC'"
                        >
                          Edit
                        </button>
                        <button
                          mat-menu-item
                          color="accent"
                          (click)="openFormDialog(element)"
                          [disabled]="
                            applicationInfo.application_status_id !== 3
                          "
                          *ngIf="
                            evaluatorRole.code == 'CBAO-LG' ||
                            evaluatorRole.code == 'CBAO-ARCH' ||
                            evaluatorRole.code == 'CBAO-STR' ||
                            evaluatorRole.code == 'CBAO-SAN' ||
                            evaluatorRole.code == 'CBAO-ELEC' ||
                            evaluatorRole.code == 'CBAO-MEC'
                          "
                        >
                          Edit
                        </button>
                        <button
                          mat-menu-item
                          color="accent"
                          (click)="openFormDialog(element)"
                          [disabled]="
                            applicationInfo.application_status_id !== 12
                          "
                          *ngIf="evaluatorRole.code == 'CBAO-DC'"
                        >
                          Edit
                        </button>
                        <button
                          mat-menu-item
                          color="accent"
                          (click)="openFormDialog(element)"
                          [disabled]="
                            applicationInfo.application_status_id !== 13
                          "
                          *ngIf="evaluatorRole.code == 'CBAO-BO'"
                        >
                          Edit
                        </button>
                      </ng-container>
                      <ng-container
                        *ngIf="applicationInfo.permit_type_id !== 1"
                      >
                        <button
                          mat-menu-item
                          color="accent"
                          (click)="openFormDialog(element)"
                          *ngIf="evaluatorRole.code !== 'CBAO-REL'"
                          [disabled]="!otherPermitsCanEdit()"
                        >
                          Edit
                        </button>
                      </ng-container>
                      <ng-container
                        *ngIf="
                          evaluatorRole.code == 'CBAO-REC' &&
                          applicationInfo.application_status_id !== 1
                        "
                      >
                        <a
                          mat-menu-item
                          href="{{ element.document_path }}"
                          target="_blank"
                          >View</a
                        >
                      </ng-container>
                      <ng-container
                        *ngIf="
                          evaluatorRole.code == 'CBAO-DC' &&
                          applicationInfo.application_status_id !== 12
                        "
                      >
                        <a
                          mat-menu-item
                          href="{{ element.document_path }}"
                          target="_blank"
                          >View</a
                        >
                      </ng-container>
                      <ng-container
                        *ngIf="
                          evaluatorRole.code == 'CBAO-BO' &&
                          applicationInfo.application_status_id !== 13
                        "
                      >
                        <a
                          mat-menu-item
                          href="{{ element.document_path }}"
                          target="_blank"
                          >View</a
                        >
                      </ng-container>
                      <ng-container
                        *ngIf="
                          (evaluatorRole.code == 'CBAO-LG' ||
                            evaluatorRole.code == 'CBAO-ARCH' ||
                            evaluatorRole.code == 'CBAO-STR' ||
                            evaluatorRole.code == 'CBAO-SAN' ||
                            evaluatorRole.code == 'CBAO-ELEC' ||
                            evaluatorRole.code == 'CBAO-MEC') &&
                          applicationInfo.application_status_id !== 3
                        "
                      >
                        <a
                          mat-menu-item
                          href="{{ element.document_path }}"
                          target="_blank"
                          >View</a
                        >
                      </ng-container>
                      <!-- <button
                        mat-menu-item
                        color="accent"
                        (click)="goToEsig(element.id)"
                        *ngIf="evaluatorRole.code !== 'CBAO-REL'"
                        [disabled]="
                          applicationInfo.application_status_id !== 24
                        "
                      >
                        Sign Document
                      </button> -->
                      <a
                        mat-menu-item
                        href="{{ element.document_path }}"
                        target="_blank"
                        *ngIf="evaluatorRole.code == 'CBAO-REL'"
                        >Print</a
                      >
                    </mat-menu>
                  </td>
                </ng-container>

                <tr
                  mat-header-row
                  *matHeaderRowDef="displayedColumns; sticky: true"
                ></tr>
                <tr
                  mat-row
                  [style.background-color]="
                    (evaluatorRole.code == 'CBAO-REC'
                      ? row.receiving_status_id
                      : evaluatorRole.code == 'CBAO-DC' ||
                        evaluatorRole.code == 'CBAO-BO' ||
                        evaluatorRole.code == 'CBAO-REL'
                      ? row.document_status_id
                      : row.cbao_status_id) == 1
                      ? '#BFF4D1'
                      : (evaluatorRole.code == 'CBAO-REC'
                          ? row.receiving_status_id
                          : evaluatorRole.code == 'CBAO-DC' ||
                            evaluatorRole.code == 'CBAO-BO' ||
                            evaluatorRole.code == 'CBAO-REL'
                          ? row.document_status_id
                          : row.cbao_status_id) == 2
                      ? '#F7C0C0'
                      : 'white'
                  "
                  *matRowDef="let row; columns: displayedColumns"
                ></tr>
              </table>
            </div>

            <div class="action__buttons">
              <ng-container *ngIf="applicationInfo.permit_type_id == 1">
                <!-- TODO MAKE THIS A COMPONENT -->
                <div *ngIf="applicationInfo.application_status_id == 13">
                  <button
                    class="mt-2 w-100"
                    mat-raised-button
                    color="primary"
                    (click)="openBldgPermitDialog()"
                    *ngIf="evaluatorRole.code == 'CBAO-BO'"
                    [disabled]="
                      checkBuildingPermitUploaded() || checkFormNonCompliant()
                    "
                  >
                    Release Building Permit
                  </button>
                </div>
                <mat-progress-bar
                  mode="indeterminate"
                  *ngIf="isLoading"
                ></mat-progress-bar>
                <div *ngIf="evaluatorRole.code !== 'CBAO-BO'"></div>

                <div class="d-flex justify-content-between mt-5">
                  <div
                    *ngIf="
                      applicationInfo.application_status_id !== 11 &&
                      !checkFormsCompliant()
                    "
                  >
                    <div
                      *ngIf="
                        applicationInfo.application_status_id !== 5 &&
                        (evaluatorRole.code == 'CBAO-REC' ||
                          evaluatorRole.code == 'CBAO-DC' ||
                          evaluatorRole.code == 'CBAO-BO')
                      "
                    >
                      <button
                        mat-raised-button
                        color="warn"
                        (click)="nonCompliant()"
                        *ngIf="applicationInfo.application_status_id !== 3"
                        [disabled]="
                          evaluatorRole.code == 'CBAO-REC' &&
                          applicationInfo.application_status_id !== 1
                        "
                      >
                        Return to Applicant
                      </button>
                    </div>

                    <div *ngIf="evaluatorRole.code !== 'CBAO-BO'">
                      <button
                        mat-raised-button
                        color="primary"
                        (click)="handleTechnicalEvaluatorNonCompliant()"
                        *ngIf="applicationInfo.application_status_id == 3"
                        [disabled]="
                          evaluatorRole.code == 'CBAO-REC' &&
                          applicationInfo.application_status_id !== 1
                        "
                      >
                        Review Done (Non-Compliant)
                      </button>
                    </div>
                  </div>
                  <div>
                    <button
                      [disabled]="checkFormNonCompliant()"
                      mat-raised-button
                      color="primary"
                      (click)="forwardToCpdo()"
                      *ngIf="
                        applicationInfo.application_status_id == 1 &&
                        evaluatorRole.code == 'CBAO-REC'
                      "
                    >
                      Forward to CPDO
                    </button>
                    <button
                      mat-raised-button
                      color="primary"
                      (click)="notifyBuildingOfficial()"
                      *ngIf="evaluatorRole.code == 'CBAO-DC'"
                      [disabled]="
                        !checkFormsCompliant() ||
                        applicationInfo.application_status_id !== 12
                      "
                    >
                      Forward to Building Official
                    </button>
                    <button
                      mat-raised-button
                      color="primary"
                      (click)="handleRelease()"
                      *ngIf="
                        evaluatorRole.code == 'CBAO-REL' &&
                        applicationInfo.application_status_id == '4'
                      "
                    >
                      Release Permit
                    </button>
                    <div *ngIf="evaluatorRole.code !== 'CBAO-BO'">
                      <button
                        mat-raised-button
                        color="primary"
                        (click)="handleTechnicalEvaluatorCompliant()"
                        *ngIf="applicationInfo.application_status_id == '3'"
                      >
                        Review Done (Compliant)
                      </button>
                    </div>

                    <button
                      mat-raised-button
                      color="primary"
                      (click)="forSignature()"
                      *ngIf="evaluatorRole.code == 'CBAO-BO'"
                      [disabled]="
                        !checkBuildingPermitUploaded() ||
                        applicationInfo.application_status_id !== 13
                      "
                    >
                      Forward for Signature
                    </button>
                  </div>
                </div>
              </ng-container>
              <ng-container
                *ngIf="
                  applicationInfo.permit_type_id !== 1 &&
                  applicationInfo.permit_type_id !== 2
                "
              >
                <app-other-permits
                  [applicationInfo]="applicationInfo"
                  [evaluatorDetails]="evaluatorDetails"
                  [evaluatorRole]="evaluatorRole"
                  [dataSource]="dataSource"
                ></app-other-permits>
              </ng-container>
            </div>
          </div>
        </mat-tab>

        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>report</mat-icon>
            General Remarks
            <mat-icon
              [matBadge]="applicationInfo.remarks.length"
              matBadgeColor="warn"
            ></mat-icon>
          </ng-template>
          <app-general-remarks
            [evaluatorDetails]="evaluatorDetails"
          ></app-general-remarks>
        </mat-tab>
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>folder</mat-icon>
            Supporting Documents
          </ng-template>
          <app-supporting-documents
            [evaluatorDetails]="evaluatorDetails"
            [applicationDetails]="applicationInfo"
          ></app-supporting-documents>
        </mat-tab>
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>engineering</mat-icon>
            Technical Evaluation
          </ng-template>
          <app-technical-evaluation
            [evaluatorDetails]="evaluatorDetails"
            [applicationDetails]="applicationInfo"
          ></app-technical-evaluation>
        </mat-tab>
        <mat-tab *ngIf="applicationInfo.permit_type_id == 1">
          <ng-template mat-tab-label>
            <mat-icon>find_in_page</mat-icon>
            Technical Findings
          </ng-template>
          <ng-container *ngIf="evaluatorDetails && applicationInfo">
            <app-technical-findings
              [evaluatorDetails]="evaluatorDetails"
              [applicationDetails]="applicationInfo"
            ></app-technical-findings>
          </ng-container>
        </mat-tab>
      </mat-tab-group>
    </mat-card-content>
  </mat-card>
</ng-container>

<div class="spinner" *ngIf="isLoading">
  <mat-spinner></mat-spinner>
</div>
