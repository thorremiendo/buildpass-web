<ng-container *ngIf="applicationDetails">
  <div class="app-details" *ngIf="!isLoading">
    <mat-card>
      <mat-card-content>
        <div class="d-flex justify-content-between">
          <div>
            <h4 style="color: #ffa653" class="mb-4">
              <strong>Application Details</strong>
            </h4>
          </div>
        </div>
        <div class="row mb-1">
          <div class="avatar-container col-md-4 text-center">
            <div>
              <h5 style="text-transform: uppercase">
                <strong
                  >&nbsp;{{
                    applicationDetails.applicant_detail.first_name
                  }}&nbsp;{{
                    applicationDetails.applicant_detail.last_name
                  }}</strong
                >
              </h5>
            </div>
            <div>
              <h5 style="color: #7b7b7b" style="text-transform: uppercase">
                {{ applicationDetails.applicant_detail.email_address }}
              </h5>
            </div>
            <div>
              <h5 style="color: #7b7b7b">
                {{ applicationDetails.applicant_detail.contact_number }}
              </h5>
            </div>
            <div>
              <h5 style="color: #7b7b7b">
                {{ applicationDetails.applicant_detail.barangay }}
              </h5>
            </div>
          </div>
          <div class="col-md-4">
            <div class="col">
              <h5 style="color: #7b7b7b">Application Number:</h5>
              <h5>
                <strong>{{
                  applicationDetails.permit_application_code
                }}</strong>
              </h5>
            </div>
            <div class="col">
              <h5 style="color: #7b7b7b">Date Submitted:</h5>
              <h5>
                <strong
                  >&nbsp;{{
                    applicationDetails.submitted_at | date: "MMMM dd, yyyy"
                  }}</strong
                >
              </h5>
            </div>
            <div
              class="col"
              *ngIf="applicationDetails.permit_released_code !== null"
            >
              <h5 style="color: #7b7b7b">Permit Number:</h5>
              <mat-icon (click)="openInputPermitNumber()">edit</mat-icon>
              <h5 style="color: green">
                <strong
                  >&nbsp;{{ applicationDetails.permit_released_code }}</strong
                >
              </h5>
            </div>
          </div>
          <div class="col-md-4">
            <div class="col">
              <h5 style="color: #7b7b7b">
                Application Status:
                <mat-icon
                  *ngIf="this.user.is_admin == 1"
                  class="material-icons-outlined"
                  (click)="
                    openAdminEditDialog(
                      applicationId,
                      getApplicationStatus(
                        applicationDetails.application_status_id
                      )
                    )
                  "
                >
                  edit
                </mat-icon>
              </h5>

              <h5
                [style.color]="
                  applicationDetails.application_status_id == 11
                    ? 'green'
                    : 'red'
                "
              >
                <strong
                  >&nbsp;
                  {{
                    getApplicationStatus(
                      applicationDetails.application_status_id
                    )
                  }}
                </strong>
              </h5>
            </div>
            <div class="col">
              <h5 style="color: #7b7b7b">Application Type:</h5>
              <h5>
                <strong
                  >&nbsp;
                  {{ getApplicationType(applicationDetails.permit_type_id) }}
                </strong>
              </h5>
            </div>
            <div class="col" *ngIf="applicationDetails.construction_status_id">
              <h5 style="color: #7b7b7b">Construction Type:</h5>
              <h5>
                <strong
                  >&nbsp;
                  {{
                    getConstructionType(
                      applicationDetails.construction_status_id
                    )
                  }}
                </strong>
              </h5>
            </div>
            <div
              class="col mt-2"
              *ngIf="applicationDetails.permit_type_id == 2"
            >
              <div class="full-partial">
                <strong class="text-center">{{
                  isPartialFull == 1 ? "Partial" : "Full"
                }}</strong>
                <strong
                  >Details:
                  <span style="color: maroon; font-weight: 600">
                    {{
                      applicationDetails.project_detail.full_partial_details
                        ? applicationDetails.project_detail.full_partial_details
                        : ""
                    }}
                  </span>
                </strong>
                <button
                  mat-stroked-button
                  color="primary"
                  (click)="editMode = !editMode"
                >
                  {{ editMode ? "Close" : "Edit" }}
                </button>
                <div *ngIf="editMode" class="mt-3">
                  <mat-radio-group [(ngModel)]="isPartialFull">
                    <mat-radio-button
                      value="1"
                      (change)="onPartialFullChange($event)"
                      >Partial</mat-radio-button
                    >
                    <mat-radio-button
                      value="2"
                      (change)="onPartialFullChange($event)"
                      >Full</mat-radio-button
                    >
                  </mat-radio-group>
                  <mat-form-field appearance="outline">
                    <input matInput [formControl]="fullPartialDetails" />
                  </mat-form-field>
                  <button
                    mat-raised-button
                    color="primary"
                    (click)="updateFullPartial()"
                  >
                    Save
                  </button>
                </div>
              </div>
              <div class="full-partial mt-3">
                <mat-radio-group [(ngModel)]="isAmendAsBuilt">
                  <mat-radio-button value="1" (change)="onAmendChange($event)"
                    >As Built</mat-radio-button
                  >
                  <mat-radio-button value="2" (change)="onAmendChange($event)"
                    >Amend</mat-radio-button
                  >
                </mat-radio-group>

                <button
                  mat-raised-button
                  color="primary"
                  (click)="handleAmend()"
                  *ngIf="isAmendAsBuilt"
                >
                  {{ isAmendSaving ? "Saving" : "Save" }}
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-5">
          <div
            *ngIf="
              applicationDetails.main_permit_id &&
              evaluatorDetails.office_id == 4
            "
            class="d-flex justify-content-center align-items-center"
          >
            <p class="m-0 p-0" style="font-weight: bold">
              Associated Building Permit Application:&nbsp;
            </p>
            <a
              [routerLink]="['../', applicationDetails.main_permit_id]"
              routerLinkActive="active"
              target="_blank"
              >View</a
            >
          </div>
          <div
            *ngIf="
              applicationDetails.sub_permit_type_id &&
              evaluatorDetails.office_id == 4
            "
            class="d-flex justify-content-center align-items-center"
          >
            <p class="m-0 p-0" style="font-weight: bold">
              Associated Excavation Permit Application:&nbsp;
            </p>
            <a
              [routerLink]="['../', applicationDetails.sub_permit_type_id]"
              routerLinkActive="active"
              target="_blank"
              >View</a
            >
          </div>
          <div>
            <button
              mat-raised-button
              color="primary"
              class="mx-1"
              (click)="openProjectDialog()"
            >
              Project Details
            </button>
            <button
              mat-raised-button
              color="primary"
              class="mx-1"
              (click)="openUploadedId(1)"
            >
              Show Uploaded ID
            </button>
            <button
              mat-raised-button
              color="primary"
              class="mx-1"
              (click)="openUploadedId(2)"
            >
              Show Selfie with ID
            </button>
            <button
              mat-raised-button
              color="accent"
              class="mx-1"
              (click)="openRepresentativeDialog()"
              *ngIf="applicationDetails.is_representative == 1"
            >
              Engineer/Architect In-charge Details
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
  <div class="app-timeline" *ngIf="!isLoading">
    <mat-card>
      <mat-card-content>
        <h4 style="color: maroon" class="mb-4">
          <strong>Application Timeline</strong>
          <hr />
        </h4>

        <div>
          <mat-expansion-panel
            (opened)="panelOpenState = true"
            (closed)="panelOpenState = false"
            class="mb-2"
          >
            <mat-expansion-panel-header>
              <mat-panel-title
                ><mat-icon
                  aria-hidden="false"
                  class="mr-2"
                  style="color: maroon"
                  >timeline</mat-icon
                >
                View Timeline</mat-panel-title
              >
            </mat-expansion-panel-header>
            <app-application-timeline
              [type]="applicationDetails.permit_type_id"
            ></app-application-timeline>
          </mat-expansion-panel>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
  <div
    class="inspection"
    *ngIf="!isLoading && evaluatorRole.code !== 'CBAO-REC'"
  >
    <mat-card>
      <mat-card-content>
        <h4 style="color: maroon" class="mb-4">
          <strong>Inspection Schedule </strong>
          <hr />
        </h4>
        <mat-expansion-panel
          (opened)="panelOpenState = true"
          (closed)="panelOpenState = false"
          class="mb-2"
        >
          <mat-expansion-panel-header>
            <mat-panel-title
              ><mat-icon aria-hidden="false" class="mr-2" style="color: maroon"
                >event</mat-icon
              >
              Inspections</mat-panel-title
            >
          </mat-expansion-panel-header>
          <div class="inspection__header">
            <button mat-raised-button color="primary" (click)="openScheduler()">
              <mat-icon>add</mat-icon> Add Inspection
            </button>
          </div>
          <ng-container *ngIf="inspections.length > 0; else noInspection">
            <div class="inspection__body">
              <ng-container *ngFor="let item of inspections; let i = index">
                <app-inspection-card
                  [details]="inspections[i]"
                  [application]="inspections[i].application_id"
                  (click)="goToApplication(inspections[i].application_id)"
                ></app-inspection-card>
              </ng-container>
            </div>
          </ng-container>
          <ng-template #noInspection>
            <p class="mt-5 text-center">No scheduled inspections</p>
          </ng-template>
        </mat-expansion-panel>
        <div></div>
      </mat-card-content>
    </mat-card>
  </div>
  <div class="app-fees" *ngIf="!isLoading">
    <mat-card>
      <mat-card-content>
        <h4 style="color: #12632a" class="mb-4">
          <strong>Application Fees</strong>
          <hr />
        </h4>
        <div>
          <mat-expansion-panel
            (opened)="panelOpenState = true"
            (closed)="panelOpenState = false"
            class="mb-2"
          >
            <mat-expansion-panel-header>
              <mat-panel-title
                ><mat-icon
                  aria-hidden="false"
                  class="mr-2"
                  style="color: maroon"
                  >file_copy</mat-icon
                >
                Application Fees Summary</mat-panel-title
              >
            </mat-expansion-panel-header>
            <app-application-fees-summary></app-application-fees-summary>
          </mat-expansion-panel>
          <mat-expansion-panel
            (opened)="panelOpenState = true"
            (closed)="panelOpenState = false"
            class="mb-2"
          >
            <mat-expansion-panel-header>
              <mat-panel-title
                ><mat-icon
                  aria-hidden="false"
                  class="mr-2"
                  style="color: maroon"
                  >build</mat-icon
                >
                City Buildings and Architecture Office</mat-panel-title
              >
            </mat-expansion-panel-header>
            <app-cbao-fees-table></app-cbao-fees-table>
          </mat-expansion-panel>
          <mat-expansion-panel
            (opened)="panelOpenState = true"
            (closed)="panelOpenState = false"
            class="mb-2"
            *ngIf="applicationDetails.permit_type_id == 1"
          >
            <mat-expansion-panel-header>
              <mat-panel-title
                ><mat-icon
                  aria-hidden="false"
                  class="mr-2"
                  style="color: maroon"
                  >create</mat-icon
                >
                City Planning and Development Office</mat-panel-title
              >
            </mat-expansion-panel-header>
            <app-cpdo-fees-table></app-cpdo-fees-table>
          </mat-expansion-panel>
          <mat-expansion-panel
            (opened)="panelOpenState = true"
            (closed)="panelOpenState = false"
            class="mb-2"
            *ngIf="
              applicationDetails.permit_type_id == 1 ||
              applicationDetails.permit_type_id == 2
            "
          >
            <mat-expansion-panel-header>
              <mat-panel-title
                ><mat-icon
                  aria-hidden="false"
                  class="mr-2"
                  style="color: maroon"
                  >local_fire_department</mat-icon
                >
                Bureau of Fire Protection</mat-panel-title
              >
            </mat-expansion-panel-header>
            <app-bfp-fees-table></app-bfp-fees-table>
          </mat-expansion-panel>
          <mat-expansion-panel
            (opened)="panelOpenState = true"
            (closed)="panelOpenState = false"
            *ngIf="
              applicationDetails.permit_type_id == 1 ||
              applicationDetails.permit_type_id == 2
            "
          >
            <mat-expansion-panel-header>
              <mat-panel-title
                ><mat-icon
                  aria-hidden="false"
                  class="mr-2"
                  style="color: maroon"
                  >grass</mat-icon
                >
                City Environment and Parks Management Office</mat-panel-title
              >
            </mat-expansion-panel-header>
            <app-cepmo-fees-table></app-cepmo-fees-table>
          </mat-expansion-panel>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
  <div
    class="app-bp"
    *ngIf="!isLoading && oldBpInfo && applicationDetails.permit_type_id == 2"
  >
    <mat-card>
      <mat-card-content>
        <h4 style="color: #141414" class="mb-4">
          <strong>Building Permit Details</strong>
          <hr />
          <div>
            <ng-container *ngFor="let item of oldBpInfo">
              <mat-expansion-panel class="my-2">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    {{ item.BUILDING_PERMIT_NUMBER }}</mat-panel-title
                  >
                </mat-expansion-panel-header>
                <div class="old__bp">
                  <p>
                    Building Permit Number:
                    <span>{{ item.BUILDING_PERMIT_NUMBER }}</span>
                  </p>
                  <p>
                    Owner Details:
                    <span>{{ item.OWNER }}</span>
                  </p>
                  <p>
                    Location:
                    <span>{{ item.LOCATION }}</span>
                  </p>
                  <p>
                    Type:
                    <span>{{ item.TYPE_OF }}</span>
                  </p>
                  <p>
                    Status:
                    <span>{{
                      getConfirmationStatus(item.BUILDING_PERMIT_NUMBER)
                        .confirmed_at !== null
                        ? "Confirmed"
                        : "Not Confirmed"
                    }}</span>
                  </p>
                  <div class="mt-4">
                    <button
                      mat-raised-button
                      color="warn"
                      (click)="deleteAssoicatedBp(item)"
                      [disabled]="
                        getConfirmationStatus(item.BUILDING_PERMIT_NUMBER)
                          .confirmed_at
                      "
                    >
                      Delete
                    </button>
                    <button
                      mat-raised-button
                      color="primary"
                      (click)="openAssociateBp(item)"
                      [disabled]="
                        getConfirmationStatus(item.BUILDING_PERMIT_NUMBER)
                          .confirmed_at
                      "
                    >
                      Confirm
                    </button>
                  </div>
                </div>
              </mat-expansion-panel>
            </ng-container>
            <ng-container *ngIf="releasedBuildingPermit">
              <div>
                <p>
                  Building Permit:&nbsp;
                  <a
                    [routerLink]="['../', releasedBuildingPermit.id]"
                    routerLinkActive="active"
                    target="_blank"
                  >
                    {{ releasedBuildingPermit.permit_released_code }}
                  </a>
                </p>
              </div>
            </ng-container>
          </div>
        </h4>
      </mat-card-content>
    </mat-card>
  </div>
  <div *ngIf="!isLoading">
    <div *ngIf="evaluatorDetails.office_id == '4'">
      <app-cbao-evaluator></app-cbao-evaluator>
    </div>
    <div *ngIf="evaluatorDetails.office_id == '1'">
      <app-cpdo-evaluator></app-cpdo-evaluator>
    </div>
    <div *ngIf="evaluatorDetails.office_id == '2'">
      <app-cepmo-evaluator></app-cepmo-evaluator>
    </div>
    <div *ngIf="evaluatorDetails.office_id == '3'">
      <app-bfp-evaluator></app-bfp-evaluator>
    </div>
  </div>
</ng-container>

<div class="spinner" *ngIf="isLoading">
  <mat-spinner></mat-spinner>
</div>
